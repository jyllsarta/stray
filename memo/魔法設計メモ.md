魔法で何をしよう

## 前提仕様

* 実装を楽にするために以下制約をおく
  * ターンの前に使用宣言
  * ターンの前に個別で効果発動
  * できることはターンの「戦闘処理前に変数書き換え」のみとする
  * MPがターン前時点で足りてないと発動できない、これに例外はない
    * アイテムとかは複雑になるので入れない
  * MP上昇量は戦闘結果依存で変わる、基本的に以下の通り
    * Power / Tech でのダメージ： 勝者5 / 敗者 10
    * SP攻撃でのダメージ： 勝者10 / 敗者20
    * 引き分け： プレイヤーのみに30(引き分けを戦略的に狙ってほしいので、ここだけプレイヤー側が明確に有利)
  * 戦闘開始時MPは0
    * パッシブで盛れるようにしたい
      * パッシブまで用意すると複雑になりすぎるので、消費MP0でMP+50する一回きりの魔法を用意する、とかにしたい
      * 実装工数もあるけど、仕組み自体をシンプルに抑えてマスタでゲームの幅を出せるようにしたい
      * あえて制約をつくったほうが面白いものができる理論
  * 増加ペースも盛れるようにする可能性はある
    * どこでインフレさせるか次第
      * 「クラスカードの一部にMPを回復する効果をもたせる」とする予定
        * 休憩やページめくりなど、戦闘では不利になるカードをお邪魔カードとして認識させない
  * 防御系魔法を使ったターンは、いかなる方法でもMPが上昇しない
    * マスタで is_defence_spell みたいなフラグがある、ダメージ軽減系にリスクをもたせる
      * 粘り腰はあるていど戦略として有効にしたいけど、危機回避のみにとどめたい。
      * 遅延戦略が最適解なゲームルールにしたくない、チキるほうが強いとなるとイライラしつつも安定勝利のためにそうせざるを得なくなる人達はいる
  * 魔法は「無限回数打てるもの」と「一回だけのもの」に分かれる
    * 無限回数のやつは当然効果量小さめ
* 敵も魔法を使う
  * プレイヤーと同等の枠数で、使用優先度を持ち、毎ターン優先度高い順に評価して使えるやつを即座に使う
    * ガンビットで、MPトリガーだけあるイメージ
      * 定期行動させたいなら使い捨ての魔法をもたせて、消費MPを調整して使う頻度を調整
      * 置き方によって相手の行動結構変わると思うので、割とこんなんで十分だと思う
        * 例えば[80必殺][20∞粘液]みたいな構成のスライムがいると、ヘタに打ち込んで必殺を発動させるとつらい、でもほっとくと粘液連打で消化してくれるみたいな敵になる


## クラス定義

* 具体的な設計はマスタでできるようにしたい
* 効果は同時に3つまで
* Magic
  * id
  * name
  * reusable
  * is_defence
  * effect1_category
    * DirectDamage とか AddPower とか
  * effect1_to_self
    * true: 自分自身 / false: 敵
  * effect1_value
    * X点ダメージ、Y枚追加ドロー
  * effect2_category
  * effect2_to_self
  * effect2_value
  * effect3_category
  * effect3_to_self
  * effect3_value

## マスタ案

* ダイレクトダメージ
  * Damage
  * 押し込み火力
  * 敵が定期的に打ってきて回避不能ダメージをねじ込んでくる
  * 敵の破局枠
  * 3-0でダメージを与える以外の戦略を追加する
* ダイレクト回復
  * AddHp
  * 余りのMPで切る持続回復
  * 一度きりの完全復活
* シールド
  * AddShield
  * このターンのみ有効な盾を生成する
  * ダメージを受けるとき、盾があれば盾のHPをへらす
  * シールド99を生成すると火力魔法も防げる完全ガードになるが、MP999にする必殺があるので∞では絶対作らない
* MPブースト
  * AddMp
  * 魔法装備枠を一個これに使うことを許容してMPを急速チャージ
* MP削り
  * DamageMp
  * 「脱力」精神コマンド。かなり強いはず
* このターンの力・技値の書き換え
  * OverridePowerThisTurn
  * OverrideTechThisTurn
  * 両方0にすると完全ガード
  * 超必殺・両面勝利を強制的に作る
* このターンの力・技の加減
  * AddPowerThisTurn, AddTechThisTurn
  * 基本技、ちょっと足りない時に切らせる
* このターンの力・技・SPダメージ値の加減
  * AddPowerDamageThisTurn, AddTechDamageThisTurn
  * 基本技、ちょっと足りない時に切らせる
* 手札上限枚数の加減  
  * AlterHandLimit
  * 自分で切ってもいいけど敵にやらせたい
  * 妨害系エネミーの対処札として取らせたい
* 手札上限枚数の更新
  * OverrideHandLimit
  * 変更ではなく、特定の値に更新する
* 次ターンドロー枚数の加減
  * AlterDrawNumber
  * スロウ付与みたいな弱めの影響を与えられる
  * システム上の最大手札枚数が8、最小が3で、この間に収まる
* 次ターンドロー枚数の更新
  * OverrideDrawNumber
  * 変更ではなく、特定の値に更新する
  * システム上の最大手札枚数が8、最小が3で、この間に収まるように結局ドローはする
* ベース火力の加減
  * AlterPower, AlterTech
  * バイキルト
  * 敵の発狂表現
* ボーナスアタックの火力追加
  * AlterSpecial
  * 必殺技強化、派手に押し込ませる、プレイ感を変えられる
* カードの恒久強化
  * こっちにあると回復と共用して耐久戦略が有効になる
  * 敵にあると発狂/持久戦略の否定ができる
  * レアリティ指定ができると良さそう？
    * クラスカードの強化
* 特定カードのデッキ投入
  * 現状の仕組み上任意のカードをロジックに持ち込むことはできないので、それぞれユニークな魔法を投入する他なさそう
  * デッキトップに置く
  * 「崩壊/20/20 をデッキトップに3枚まとめておく」大崩壊、みたいな完全ユニーク魔法になる、それぞれカテゴリレベルでユニーク
* 残り手札のディスカード
  * DiscardHands
  * 単純に弱札整理に便利だが、弱い
  * 敵にいたずらに打たせると適度にうざいと思う
* 最強カードのディスカード
  * DiscardStrongestHand
  * 残り手札でPower, Tech の合計値が一番高いカードを捨札に置かせる
* 条件を満たしたら特大ダメージを与える魔法が欲しい
  * PKスターストーム、夢想転生
  * 一発きりの大ダメージ
  * 重い条件を付加したい、HP1、MP100、特定対応カード(最強のクラスカード)を切っている時のみ効果あり
  * ダイレクトダメージ15 / SP攻撃ダメージ+5 / このターンの敵能力0
  * このターンの敵能力0 / MPが999になる
  * 序盤に DD5 / ATK+1 / HP+3 程度のプチ必殺をあげたい気持ちもあるね

## サーバ設計メモ

なんか魔法っていうよりスキルなので、コード上ではスキル統一のが良さそうだな

* 魔法マスタがある、上のメモ通り
* 「所持魔法リスト」という概念がある
* レリックの取得時、魔法アンロックカテゴリの場合は同一トランザクションにて当該魔法をユーザに付与
* 戦闘の報酬としても付与されることがある(火の鳥討伐で無限ファイアあげる、みたいなことがしたい)
* 所持している魔法はなくならない、魔法の取得ルートはこのふたつのみ

## 戦闘設計メモ

* 所持魔法リストから魔法を最大5つ選び、エンゲージ時に渡す
* 魔法マスタはバトルロジックでは持たず、今回出る魔法の名前と効果リストをエンゲージ時に渡す
* Decide時、魔法にチェックが入ってたらOperationHistoryに記録、魔法使用フェーズでEffect1から順に再生
* 魔法カテゴリいっこいっこについて、バトルクラスのインスタンスをもらって環境を更新する execute メソッドを持ったクラスとして個別に実装をする(ちょっとおっかねー気もするけど、まあこれでいけるつもり)
