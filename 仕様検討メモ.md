# stray実装メモ

## ひとことアピール

「おてがるデスクトップの隅っこ放置系RPG第二弾！」

## このゲームの面白さとはなんなのか

* **手軽** な進捗感
* かわいい
* 毎日少しずつ状況が変わる
  * 実態は日めくりカレンダーとかジグソーパズルが近い
* 自分で考えた装備構成に対するフィードバックがある
* 武器構成に関して **少しだけ考える** 必要がある
* 人によって解が違うパズルを出す
  * レアアイテムをみんなが持っているわけではない
  * このコモンにこれだけの強化値がついているのは珍しい
  * 最終的な解は一通りで構わないけど、その解にたどり着くまでの道中に局所最適化された俺だけのデッキをいくつも作りたい
  * ローグライトで変なレリックを拾って特化構成を急に検討しだすアレを再現したい
* ごく一部のレアアイテム掘り
  * エクスカリバーと炙り食品サンプル
  * 「なにか一つ突破口となるアイテムを拾ってそれを前提に組んでみたら最強装備構成ができてしばらく無双できた」がコア体験
* 2週間夢中で触って全クリ、安定期に持ち込み、最大1~2ヶ月はアイテム掘りや図鑑埋めで遊び尽くしに行けるボリュームを目指す
  * 3日に1日は考えることが増える新ダンジョンや新要素を追加して考え続けさせたい
    * シム系ゲームの「自動化を自動化」がなにげに近い考え方かも
      * となるとスキルツリー...はだんだん大げさになってきた感
      * RFAの途中からスキルツリー開放はすごくいいアイデアだった
      * スキルツリー開放が一気に進むサブダンジョンみたいなのを脇道でプレイさせるといいぞ

## このゲームがやらないこと

* 日常における思考リソースを制限しすぎない
  * 悩んで悩んで最高の解をだしてそれにしばらく快適攻略は許すが、その装備構成を探すための修行用編成で
* 超高難易度トライアンドエラーボスの連発
  * 天嶺の妖精郷みたいなのは例外として許容するけど、日常生活においてしばらくボス対策で止まるみたいなことはしない
* 他プレイヤーとの競争

## 今の悩み

* ややこしすぎない戦闘ロジック
  * 戦闘ロジックを理解した上でデッキを組んでもらいたい
  * 理解できないと組む楽しさを理解することはできない
  * 「あちらが立てばこちらが立たずのバランスがうまくとれた」は必須
  * 極振りが強くない戦闘にしなきゃいけない
* ボスを強くしすぎると面白くない
  * ボス用の編成をさせるのは煩雑
  * じゃあボスを強くすればいいかというと「修行」を強いるのは手軽な進捗感を損なう
  * サブクエ埋めみたいなのがあると修行をうまいことごまかせていいかも？
* 雑魚的に個性をある程度出して「火力不足」「防御突破されがち」が認識できるようになると良さそう

## マスタデータ管理について

戦闘ロジックをどうやってきれいにRailsに組み込もう？
クライアントでは絶対欲しい
    エンチャつけ外しごとに通信してらんない

マスターデータのseedとjsonへの吐き出しを別々にするといい説ある
stray-masterdataをseedするとDB展開とクライアント用jsonを別々に吐く

## コアサイクルに必要なもの

* ほっとくといろいろなことが起こる
* 戦闘が発生する
* アイテムが貰える
* 死ぬ
  * 死んでる間はイベントが発生しない
* 世話をする
* 装備を色々組み替える
* インフレしていく

## APIぼんやりメモ

* 原則全イベントロジックはサーバに寄せる。サーバ偏重構成にする
* クライアントの役割は以下に徹する
  * マスタデータをロードしてUI表示を行う
  * サーバからもらった演出を再生する
* アセット抜き方面でのチート対策は一切行わない
  * F12を押して終盤の装備のネタバレ見ちゃった！みたいなのは許容
* サーバのチート対策は一般的なソシャゲ準拠を目指す
  * ロジックをサーバに寄せていればクライアント側から派手なチートを行うのはだいぶ難しいはず

以下以外にも装備変更とかいくらでもあると思うけど、クライアントサーバのモックがともにできてイベント再生に伴うゲーム進行ループの機構が回りだしたタイミングで再検討でいいと思う

### /clients

クライアントのVueアプリを返す

### POST /user/:id/refresh

60秒ごとに叩かせる

```json
{
    // まだ見てないイベントが全部来る
    // クライアント側はこの内容を見て前から順番に再生していく
    events: [
        {
            type: "item",
            detail: {
                itemId: 123,
                rank: 4,
                isNew: false,
            }
        },
        {
            type: "battle",
            detail: {
                itemId: 123,
                rank: 4,
                isNew: false,
            }
        },
        {
            type: "stair",
            detail: {
                reachedMax: false,
                downedTo: 500,
            }
        },
    ],
    now: 123123123,
    nextEventTime: 123123123, //クライアント側でこの時刻+1秒になったらもう一度叩く
}
```

演出に必要なものが全部サーバレスポンスに入ってるイメージ

### GET user/:id/status

ユーザデータの初回読み込みに使わせる
認証はどうしような... 超雑だけど魅魔Qのアクセストークン方式がいいかな...?

```json
{
    id: 123123123,
    next_event_at: 123123123,
    hp: 33,
    maxHp: 100,
    ...
}
```

## 認証

### 要件

* ゲームを開いたらいきなり始まる
* 右メニューからアカウント登録が可能
  * ユーザIDとパスワードを送って登録
  * そこでログインも可能
  * ユーザIDとパスワードが既存ユーザと一致するならそのユーザとしてプレイを再開可能

### どう実現するか

* cookieにあるアクセストークンを信頼してプレイさせればOK
* mountのタイミングでcookieにアクセストークンがあるかどうか確認
  * あるなら /user/:id/status をアクセストークン付きでリクエスト
    * アクセストークンが有効なら更新されたユーザで初期状態が取れるのでよし
    * アクセストークンが無効ならcookieを消しちゃってないときの処理にフォールバック
  * ないなら /user/create を叩いてアクセストークンを取得
    * 手に入ったアクセストークンで /user/:id/status を叩いてみる
* トークンの有効期限はどうしようね...

### POST /user/create

#### request body

空

#### response body

{
  access_token: "1234567890abcdef"
}

### POST /user/:id/edit

#### request body

認証必須のAPIとする、のでこれに加えてアクセストークンをリクエストヘッダに含める

```json
{
  "id": "example",
  "password": "secret_password"
}
```

#### response body

```json
{
  "success": true  
}
```

### POST /login

再認証を行い、アクセストークンを返す

#### request body
```json
{
  "id": "example",
  "password": "secret_password"
}
```

#### response body

```json
{
  "access_token": "1234567890abcdef"
}
```

## モデル

* User
  * id
  * username
  * encrypted_password

* AccessToken
  * id
  * user_id
  * token

* Dungeon
  * id
  * min_enemy_rank
  * max_enemy_rank
  * depth
  * name
  * description
  * event_stair_weight
  * event_battle_weight
  * event_item_weight
  * boss_interval #frequencyと悩むけどintervalのが説明的かな...?

* Item
  * id
  * rarity
  * str
  * dex
  * def # ATK/DEF と被るからなんとか回避したいんだけどね
  * agi
  * 他にもありそうだけどコアループのアルファ作ってから！！

* User::Equip
  * id
  * character_id
  * position
  * user_item_id

* User::Item
  * id
  * item_id
  * level

* User::Status
  * user_id
  * status_update_at

* User::Character
  * id
  * user_id
  * character_id
  * hp
  * lv
  * exp

* User::DungeonProgress
  * id
  * user_id
  * dungeon_id
  * depth
  * cleared


コア開発にいらないもの
Faily
Enchant
Perk

### GET /masterdata

マスタデータのjsonをぽんと渡す

## ミドルウェア

* rails 6.0.2
* Vue 2.6.11
* Ruby 2.5.1
* ridgepole

## テスト用アイテム案

コア開発では全然いらんけど本開発になったら全力で作りに行かないとここで詰む
しろことくろこの自他ともに認めるメインコンテンツはこれ。5層あたりの特別変化が生まれないパートをプレイアブルにしてくれたのは完全にこれのおかげ。ここの物量は絶対妥協しない

おはじき つい拾ってしまった。とくに戦闘において有利な加護はついていないが、いいものを見つけた満足感で少し強くなれる。
ビー玉 つい拾ってしまったシリーズ2号。きらきらしたものを拾いがち。
食品サンプル 言わずとしれた最強バランスアイテム。ステータスバランスを崩さずにモリッと強くしてくれます。
エクスカリ葉 聖剣のような形をした葉っぱ。モサモサに生えるためありがたみはあまりないが、エクスカリの木はマナを葉に貯めるため霊力を湛えている。
ばけのかわ かるくつついただけで簡単に剥がれてしまうが、これははがれることで衝撃を吸収しているため。
おはぎ きなこ味。まだ少し暖かい。
しろこパフェ しろこが作ったパフェ。コーンフレーク層に溶けたアイスといちごソースがからまります。
ショートブレード 初心者用の扱いやすい剣。でも剣は剣なので、ちゃんと重い。駆け出し冒険者が見栄を張って買うもののすぐに家に置きっぱなしになるぞ。
サクラリフレクション 桜印の魔法盾。意識を盾に集中させると大きくなって身を守ります。
桜花刀 桜の紋様が彫られた日本刀。桜シリーズの武器枠。
さくらもち 塩漬けにした桜の葉で巻いたおもち。塩気がちょうどいい...!
ねこみみ ねこみみだ。このゲームでは装備してもグラフィックが変わったりしない。名前も変わらない。
星砂ボトル 星型の砂を小さなボトルに詰めたお土産。砂じゃなくてそういう生き物の殻なんですよ。
ブーメラン 全体攻撃だ！つよいぞ！と意気込んで買ったら宝箱から出てくる。
miniSDカード あんま小さくなくない？

FT未実装でもいいからひたすら案
アイスクレイモア
灰エリオン沸石



## キャラ

### スピカ

* 14歳
* スピカ・＊＊＊＊＊＊＊
* 中立・善執行
* 「道を切り開く」強化する
* 直観・天運に恵まれ、自覚的にその最高値固定の運気を利用して行動するやっかいな主人公
* 行った先がゴールになる(している)
* チロルからの信頼を信頼している
* ピンク・黄色
* 剣を持ったハツネ
* 妖精派で、契約した妖精から加護(reinforcement)の執行(execute)をうけることが可能。様々な妖精と契約して相手に有利な状態で戦うスタイル。
  * ゲーム中では任意の妖精を一体選んで一定の基礎能力強化+ユニークなパッシブスキルの付与を受けられる
* (そこそこ)おおきい
* モチーフは星
* 実家が太く、変なところで育ちの良さを見せる
* 陽キャ
* ぱっちりおめめ
* 甘い物好き

### チロル

* 14歳
* 秩序・善
* 「リストアップして、選び取る」
* ＊＊＊ちろる
* 作中で略記される場合はカタカナ表記のチロルになる
* 弟がいる。11歳
* スピカの友人。スピカにはたくさん友人がいるけどチロルの友人はスピカと弟だけ
* 別に運が悪いわけではない。一般的な人間と同じ程度にバイオリズムがある
* 魔法派で、モジュールによる強化(augmentation)の換装(install)を受けることが可能。この世界の魔法は技術用語めいている
  * ゲーム中では任意のモジュールを一つ選んで一定の基礎能力強化+ユニークなパッシブスキルの付与を受けられる
* ぺたんこ
* モチーフは重なった四角形
* 水色・紺色
* 陰キャ
* ジト目
* 調理スキルがある
* インターネットのオタク
