# stray実装メモ

## ひとことアピール

「おてがるデスクトップの隅っこ放置系RPG第二弾！」

## このゲームの面白さとはなんなのか

* **手軽** な進捗感
* かわいい
* 毎日少しずつ状況が変わる
  * 実態は日めくりカレンダーとかジグソーパズルが近い
* 自分で考えた装備構成に対するフィードバックがある
* 武器構成に関して **少しだけ考える** 必要がある
* 人によって解が違うパズルを出す
  * レアアイテムをみんなが持っているわけではない
  * このコモンにこれだけの強化値がついているのは珍しい
  * 最終的な解は一通りで構わないけど、その解にたどり着くまでの道中に局所最適化された俺だけのデッキをいくつも作りたい
  * ローグライトで変なレリックを拾って特化構成を急に検討しだすアレを再現したい
* ごく一部のレアアイテム掘り
  * エクスカリバーと炙り食品サンプル
  * 「なにか一つ突破口となるアイテムを拾ってそれを前提に組んでみたら最強装備構成ができてしばらく無双できた」がコア体験
* 2週間夢中で触って全クリ、安定期に持ち込み、最大1~2ヶ月はアイテム掘りや図鑑埋めで遊び尽くしに行けるボリュームを目指す
  * 3日に1日は考えることが増える新ダンジョンや新要素を追加して考え続けさせたい
    * シム系ゲームの「自動化を自動化」がなにげに近い考え方かも
      * となるとスキルツリー...はだんだん大げさになってきた感
      * RFAの途中からスキルツリー開放はすごくいいアイデアだった
      * スキルツリー開放が一気に進むサブダンジョンみたいなのを脇道でプレイさせるといいぞ

## このゲームがやらないこと

* 日常における思考リソースを制限しすぎない
  * 悩んで悩んで最高の解をだしてそれにしばらく快適攻略は許すが、その装備構成を探すための修行用編成で
* 超高難易度トライアンドエラーボスの連発
  * 天嶺の妖精郷みたいなのは例外として許容するけど、日常生活においてしばらくボス対策で止まるみたいなことはしない
* 他プレイヤーとの競争

## 今の悩み

* ややこしすぎない戦闘ロジック
  * 戦闘ロジックを理解した上でデッキを組んでもらいたい
  * 理解できないと組む楽しさを理解することはできない
  * 「あちらが立てばこちらが立たずのバランスがうまくとれた」は必須
  * 極振りが強くない戦闘にしなきゃいけない
* ボスを強くしすぎると面白くない
  * ボス用の編成をさせるのは煩雑
  * じゃあボスを強くすればいいかというと「修行」を強いるのは手軽な進捗感を損なう
  * サブクエ埋めみたいなのがあると修行をうまいことごまかせていいかも？
* 雑魚的に個性をある程度出して「火力不足」「防御突破されがち」が認識できるようになると良さそう

## マスタデータ管理について

戦闘ロジックをどうやってきれいにRailsに組み込もう？
クライアントでは絶対欲しい
    エンチャつけ外しごとに通信してらんない

マスターデータのseedとjsonへの吐き出しを別々にするといい説ある
stray-masterdataをseedするとDB展開とクライアント用jsonを別々に吐く

## コアサイクルに必要なもの

* ほっとくといろいろなことが起こる
* 戦闘が発生する
* アイテムが貰える
* 死ぬ
  * 死んでる間はイベントが発生しない
* 世話をする
* 装備を色々組み替える
* インフレしていく

## APIぼんやりメモ

* 原則全イベントロジックはサーバに寄せる。サーバ偏重構成にする
* クライアントの役割は以下に徹する
  * マスタデータをロードしてUI表示を行う
  * サーバからもらった演出を再生する
* アセット抜き方面でのチート対策は一切行わない
  * F12を押して終盤の装備のネタバレ見ちゃった！みたいなのは許容
* サーバのチート対策は一般的なソシャゲ準拠を目指す
  * ロジックをサーバに寄せていればクライアント側から派手なチートを行うのはだいぶ難しいはず

以下以外にも装備変更とかいくらでもあると思うけど、クライアントサーバのモックがともにできてイベント再生に伴うゲーム進行ループの機構が回りだしたタイミングで再検討でいいと思う

### /clients

クライアントのVueアプリを返す

### POST /user/:id/refresh

60秒ごとに叩かせる

```json
{
    // まだ見てないイベントが全部来る
    // クライアント側はこの内容を見て前から順番に再生していく
    events: [
        {
            type: "item",
            detail: {
                itemId: 123,
                rank: 4,
                isNew: false,
            }
        },
        {
            type: "battle",
            detail: {
                itemId: 123,
                rank: 4,
                isNew: false,
            }
        },
        {
            type: "stair",
            detail: {
                reachedMax: false,
                downedTo: 500,
            }
        },
    ],
    now: 123123123,
    nextEventTime: 123123123, //クライアント側でこの時刻+1秒になったらもう一度叩く
}
```

演出に必要なものが全部サーバレスポンスに入ってるイメージ

### GET user/:id/status

ユーザデータの初回読み込みに使わせる
認証はどうしような... 超雑だけど魅魔Qのアクセストークン方式がいいかな...?

```json
{
    id: 123123123,
    next_event_at: 123123123,
    hp: 33,
    maxHp: 100,
    ...
}
```

## 認証について

* URLをクリックしたらいきなりゲームスタートはマスト
  * 登録画面を出した瞬間にコンバージョン半分以下になるのは目に見えてる
* cookieなしでアクセスした段階で `/register` を叩いてアクセストークンとユーザを発行、アクセストークンは引き継ぎ可能が丸いか

## モデル

* User
  * id
  * username
  * encrypted_password
* AccessToken
  * id
  * user_id
  * token

* Dungeon
  * id
  * min_enemy_rank
  * max_enemy_rank
  * depth
  * name
  * description
  * event_stair_weight
  * event_battle_weight
  * event_item_weight
  * boss_interval #frequencyと悩むけどintervalのが説明的かな...?

* Item
  * id
  * rarity
  * str
  * dex
  * def # ATK/DEF と被るからなんとか回避したいんだけどね
  * agi
  * 他にもありそうだけどコアループのアルファ作ってから！！

* User::Equip
  * id
  * character_id
  * position
  * user_item_id

* User::Item
  * id
  * item_id
  * level

* User::Status
  * user_id
  * status_update_at

* User::Character
  * id
  * user_id
  * character_id
  * hp
  * lv
  * exp

* User::DungeonProgress
  * id
  * user_id
  * dungeon_id
  * depth
  * cleared


コア開発にいらないもの
Faily
Enchant
Perk

### GET /masterdata

マスタデータのjsonをぽんと渡す

## ミドルウェア

* rails 6.0.2
* Vue 2.6.11
* Ruby 2.5.1
* ridgepole

## テスト用アイテム案

コア開発では全然いらんけど本開発になったら全力で作りに行かないとここで詰む
しろことくろこの自他ともに認めるメインコンテンツはこれ。5層あたりの特別変化が生まれないパートをプレイアブルにしてくれたのは完全にこれのおかげ。ここの物量は絶対妥協しない

おはじき つい拾ってしまった。とくに戦闘において有利な加護はついていないが、いいものを見つけた満足感で少し強くなれる。
ビー玉 つい拾ってしまったシリーズ2号。きらきらしたものを拾いがち。
食品サンプル 言わずとしれた最強バランスアイテム。ステータスバランスを崩さずにモリッと強くしてくれます。
エクスカリ葉 聖剣のような形をした葉っぱ。モサモサに生えるためありがたみはあまりないが、エクスカリの木はマナを葉に貯めるため霊力を湛えている。
ばけのかわ かるくつついただけで簡単に剥がれてしまうが、これははがれることで衝撃を吸収しているため。
おはぎ きなこ味。まだ少し暖かい。
しろこパフェ しろこが作ったパフェ。コーンフレーク層に溶けたアイスといちごソースがからまります。
ショートブレード 初心者用の扱いやすい剣。でも剣は剣なので、ちゃんと重い。駆け出し冒険者が見栄を張って買うもののすぐに家に置きっぱなしになるぞ。
サクラリフレクション 桜印の魔法盾。意識を盾に集中させると大きくなって身を守ります。
桜花刀 桜の紋様が彫られた日本刀。桜シリーズの武器枠。
さくらもち 塩漬けにした桜の葉で巻いたおもち。塩気がちょうどいい...!
ねこみみ ねこみみだ。このゲームでは装備してもグラフィックが変わったりしない。名前も変わらない。
星砂ボトル 星型の砂を小さなボトルに詰めたお土産。砂じゃなくてそういう生き物の殻なんですよ。
ブーメラン 全体攻撃だ！つよいぞ！と意気込んで買ったら宝箱から出てくる。
miniSDカード あんま小さくなくない？

FT未実装でもいいからひたすら案
アイスクレイモア
